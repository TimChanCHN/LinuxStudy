# 触摸屏驱动

## 1. 说明
1. 基本原理：触摸屏是由两层膜叠加而成，可以等效成两个正交的滑动变阻器，通过对这两个滑动变阻器进行ADC采样，来确定触点在屏幕的具体坐标；
2. 触摸屏使用步骤：
   1. 按下触摸屏，触发中断(IRQ_TC)；
   2. 在触摸屏中断中，启动ADC转换XY坐标；
   3. ADC接触，触发ADC中断(IRQ_ADC);
   4. 在ADC中断中，上报数据，并且启动定时器
   5. 定时结束后，假如还是按下或者滑动，则转去(2)，继续处理触摸屏数据；
   6. 松开
3. 触摸屏也是输入子系统的一个例子，如果需要把数据上报，则需要做setbits等操作。

## 2. 触摸屏配置步骤
1. 输入子系统配置
   1. 分配input_event结构体
   2. 设置输入事件名称、设置触发事件类型、设置触发事件类型的哪类事件
   3. 注册输入子系统设备
2. 硬件操作（寄存器相关操作）
   1. 获得并使能外设时钟（此处外设是adc)
   2. 通过ioremap获得相关寄存器的操作地址--对于相关性较强的寄存器，可以设置成同一个结构体，若各个地址不连续需要补占位变量，数据类型是unsigned long，目的是为了和系统的位数一致
      1. 使能预分频功能，使得系统分配给ADC的时钟频率和ADC模块匹配
4. 其他操作
   1.  使能触摸屏中断，用于检测触摸笔按下松开
   2.  使能ADC中断,用于当ADC转换结束后触发中断
   3.  定时器中断，用于解决连续按、滑动
5. 以上是初始化步骤，当初始化后，进行以下操作：
   1. 使能系统处于一种检测触摸笔何时按下：adctsc 0xd3，当触发了触摸屏中断，通过判断adcdat0的bit15来判断是按下中断或者松开中断，当按下时，该bit为低，处理完数据后需要切换状态为检测松开状态；同理，当松开时也要做这种状态切换；
   2. 在按下触摸笔时，通过配置寄存器adctsc，使其处于一种自动检测x/y轴数据的状态--本质主要是禁止上拉，同时两个方向的开关配合采样；
   3. 打开ADC开关，即可以在ADC中断中对采样数据进行处理，可以配置寄存器adcdly，延迟一段时间，使得ADC采样稳定后再触发中断；
   4. 为解决滑动的问题，可以在ADC中断函数中，假如触摸笔还是按下的话，则启动定时器，定时一段时间后，假如触摸笔还是按下，则认为是连续滑动，则继续使能ADC自动连续采样状态；如果已经松开，则切换状态为等待按下状态，并且上报数据到应用层即可。